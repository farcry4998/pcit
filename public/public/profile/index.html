<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/js-cookie/2.2.0/js.cookie.min.js"></script>
  <title>KhsCI - Profile</title>
</head>
<body>
<header>
  This Is Header
  <br>
  <br>
</header>
<div id="userinfo">
  <p id="username"></p>
  <button id="sync" onclick="sync()">Sync</button>
</div>
<br>

<div class="tip">
  <p id="feature">
    <strong>Interested in trying beta features?</strong> <a href="/features">Check out what's new.</a>
  </p>
</div>
<hr>
<br>
<div id="repos">

</div>

<script>

  let ci_host = "https://" + document.location.host + "/";

  let git_type = (location.href.split('/'))[4];

  function list(data) {
    $("#username").text("Welcome " + data.username).addClass(data.type);

    let git_type = data.git_type;

    $("title").text(git_type + ' - ' + data.username + " - Profile - KhsCI");

    $.each(data.repos, function (repo, status) {

      let button = $("<button></button>");

      button.attr("onclick", 'open_or_close(this)');

      if (status === (1).toString()) {
        button.text('Close');
        button.css('color', 'green');
      } else {
        button.text('Open');
        button.css('color', 'red');
      }

      console.log(repo);
      console.log(status);

      // <p id="username/repo">username/repo</p>
      let p = $("<a></a>").text(repo);

      p.attr("id", repo);
      p.attr('href', ci_host + git_type + '/' + repo);
      p.attr('target', '_blank');
      button.attr("id", repo);
      button.css('text-align', 'right');
      p.css('display', 'inline');

      let settings = $("<a></a>");

      settings.text('Setting');
      settings.attr('href', ci_host + git_type + "/" + repo + "/settings");
      settings.attr('target', '_blank');
      $("#repos").append(button).append('&nbsp;&nbsp;').append(settings).append('&nbsp;&nbsp;').append(p).append('<br>');
    })
  }

  $(document).ready(function () {

    $.ajax({
      type: "GET",
      url: "/api/user",
      headers: {
        'Authorization': 'token ' + Cookies.get(git_type + '_api_token')
      },
      success: function (data) {
        list(data[0]);
      }
    });

    $.ajax({
      type: "GET",
      url: "/api/orgs",
      headers: {
        'Authorization': 'token ' + Cookies.get(git_type + '_api_token')
      },
      success: function (data) {

      }
    });

    $.ajax({
      type: "GET",
      url: "/api/repos",
      headers: {
        'Authorization': 'token ' + Cookies.get(git_type + '_api_token')
      },
      success: function (data) {

      }
    });

    if ('github' === git_type) {
      $.ajax({
        type: "GET",
        url: "/api/ci/oauth_client_id",
        headers: {
          'Authorization': 'token ' + Cookies.get(git_type + '_api_token')
        },
        success: function (data) {
          $('.tip').after(
            `<p>
<strong>Missing an organization?</strong>
<a href="${data}" target="_blank"> Review and add </a> your authorized organizations.
</p>`
          );
        }
      });
    }

  });

  function sync() {
    $.ajax({
      type: 'POST',
      url: '/api/user/sync',
      headers: {
        'Authorization': 'token ' + Cookies.get(git_type + '_api_token')
      },
      success: function (data) {
        location.reload();
      }
    })
  }

  function open_or_close(id) {
    let repo = id.getAttribute('id');
    let status = id.innerHTML;
    if ('Open' === status) {

      $.ajax({
        type: "POST",
        url: ci_host + "webhooks/" + git_type + "/" + repo + "/199412/activate",
        dataType: "json",
        contentType: 'application/json;charset=utf-8',
        success: function (data) {
          id.innerHTML = 'Close';
          id.style.color = 'Green';
        }
      })
    } else {

      $.ajax({
        type: "delete",
        url: ci_host + "/webhooks/" + git_type + "/" + repo + "/199412/deactivate",
        success: function (data) {
          id.innerHTML = 'Open';
          id.style.color = 'Red';
        }
      });

    }
  }
</script>
</body>
</html>
